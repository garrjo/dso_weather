<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSO Weather Forecast</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <style>
        :root {
            --bg-dark: #1a1a2e;
            --bg-card: #242442;
            --bg-card-hover: #2d2d52;
            --accent-blue: #4a9eff;
            --accent-gold: #f0c040;
            --accent-orange: #ff8c42;
            --accent-red: #ff4757;
            --accent-green: #2ed573;
            --accent-purple: #a55eea;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b8;
            --text-dim: #6c6c8a;
            --border: #3a3a5c;
        }

        [data-theme="light"] {
            --bg-dark: #f0f2f5;
            --bg-card: #ffffff;
            --bg-card-hover: #f5f5f5;
            --accent-blue: #2563eb;
            --accent-gold: #d97706;
            --accent-orange: #ea580c;
            --accent-red: #dc2626;
            --accent-green: #16a34a;
            --accent-purple: #9333ea;
            --text-primary: #1a1a2e;
            --text-secondary: #4b5563;
            --text-dim: #9ca3af;
            --border: #e5e7eb;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
            transition: background 0.3s, color 0.3s;
        }

        [data-theme="light"] {
            background: linear-gradient(135deg, #f0f2f5 0%, #e5e7eb 50%, #f0f2f5 100%);
        }

        [data-theme="light"] .detail-card,
        [data-theme="light"] .current-weather,
        [data-theme="light"] .dso-risk,
        [data-theme="light"] .forecast-day {
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .dashboard { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .location-section { display: flex; flex-direction: column; gap: 0.5rem; }

        .location {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
        }

        .location-pin { color: var(--accent-red); }

        .location-select {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            max-width: 300px;
        }

        .location-select:focus { outline: none; border-color: var(--accent-blue); }

        .last-updated { color: var(--text-secondary); font-size: 0.85rem; }

        .header-buttons { display: flex; gap: 0.5rem; }

        .btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .btn:hover { background: var(--bg-card-hover); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--accent-blue); border-color: var(--accent-blue); }

        /* Hero Section */
        .hero {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .current-weather, .dso-risk {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
            display: flex;
            flex-direction: column;
        }

        .weather-main {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 1rem;
        }

        .weather-icon { font-size: 4rem; }
        .temp-display { font-size: 4.5rem; font-weight: 300; line-height: 1; }
        .temp-display .unit { font-size: 2rem; color: var(--text-secondary); }
        .condition { font-size: 1.5rem; font-weight: 500; margin-bottom: 0.25rem; }
        .feels-like { color: var(--text-secondary); font-size: 1rem; }
        .weather-summary { color: var(--text-secondary); margin: 1rem 0; font-size: 0.95rem; }

        .quick-stats {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            margin-top: auto;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .quick-stat { text-align: center; }
        .quick-stat-label { font-size: 0.75rem; color: var(--text-dim); margin-bottom: 0.25rem; }
        .quick-stat-value { font-size: 1rem; font-weight: 500; }

        /* DSO Risk Panel */
        .risk-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .risk-title { font-size: 0.9rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }

        .risk-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .risk-minimal { background: var(--accent-blue); }
        .risk-low { background: var(--accent-green); }
        .risk-moderate { background: var(--accent-orange); }
        .risk-high { background: var(--accent-red); }

        .risk-level { font-size: 3rem; font-weight: 700; margin-bottom: 0.5rem; }
        .risk-summary { color: var(--text-secondary); margin-bottom: 1rem; }

        .month-risk-strip {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .month-risk-card {
            flex: 1;
            text-align: center;
            padding: 0.4rem 0.25rem;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            cursor: help;
            transition: transform 0.2s;
        }

        .month-risk-card:hover {
            transform: scale(1.05);
        }

        .month-risk-name {
            font-size: 0.6rem;
            color: var(--text-dim);
            margin-bottom: 0.25rem;
            text-transform: uppercase;
        }

        .month-risk-meter {
            width: 20px;
            height: 8px;
            border-radius: 4px;
            margin: 0 auto;
        }

        .meter-green { background: var(--accent-green); }
        .meter-yellow { background: var(--accent-gold); }
        .meter-red { background: var(--accent-red); }

        .dso-indices {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: auto;
        }

        .dso-index {
            text-align: center;
            padding: 0.75rem;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }

        .dso-index-value { font-size: 1.5rem; font-weight: 600; color: var(--accent-gold); }
        .dso-index-label { font-size: 0.75rem; color: var(--text-dim); }

        /* Forecast Strip */
        .forecast-strip {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }

        .forecast-day {
            flex: 1 1 0;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 0.75rem;
            text-align: center;
            min-width: 120px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .forecast-day:hover { background: var(--bg-card-hover); }
        .forecast-day.active { border-color: var(--accent-blue); }

        .forecast-day-name { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem; }
        .forecast-day-date { font-size: 0.75rem; color: var(--text-dim); margin-bottom: 0.5rem; }
        .forecast-icon { font-size: 1.75rem; margin: 0.25rem 0; }
        .forecast-condition { font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 0.25rem; }
        .forecast-rain-chance { font-size: 0.7rem; color: var(--accent-blue); margin-bottom: 0.5rem; font-weight: 500; }

        .forecast-indices {
            display: flex;
            flex-direction: column;
            gap: 2px;
            font-size: 0.6rem;
            color: var(--text-dim);
            border-top: 1px solid var(--border);
            padding-top: 0.5rem;
            margin-top: 0.5rem;
        }

        .forecast-index {
            display: flex;
            justify-content: space-between;
            padding: 1px 4px;
        }

        .forecast-index-label { color: var(--text-dim); }
        .forecast-index-value { color: var(--accent-gold); font-weight: 600; }

        /* Gauge */
        .gauge-container {
            position: relative;
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            margin: 1rem 0;
            overflow: hidden;
        }

        .gauge-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
        .gauge-gradient { background: linear-gradient(90deg, var(--accent-green), var(--accent-gold), var(--accent-orange), var(--accent-red)); }

        /* Detail Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
        }

        .detail-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
        }

        .detail-card.wide { grid-column: span 2; }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title { font-size: 0.85rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        .card-icon { font-size: 1.25rem; opacity: 0.7; }
        .card-value { font-size: 2.25rem; font-weight: 600; margin-bottom: 0.25rem; }
        .card-value .unit { font-size: 1rem; color: var(--text-secondary); font-weight: 400; }

        .card-status { display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; margin-bottom: 0.5rem; }

        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .status-good { background: var(--accent-green); }
        .status-moderate { background: var(--accent-orange); }
        .status-poor { background: var(--accent-red); }

        .card-description { font-size: 0.8rem; color: var(--text-dim); margin-top: auto; }

        /* Wind Compass */
        .wind-compass {
            width: 80px;
            height: 80px;
            border: 2px solid var(--border);
            border-radius: 50%;
            position: relative;
            margin: 0 auto 1rem;
        }

        .compass-arrow {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 35px;
            background: var(--accent-blue);
            transform-origin: bottom center;
            border-radius: 2px;
        }

        .compass-label { position: absolute; font-size: 0.65rem; color: var(--text-dim); }
        .compass-n { top: 4px; left: 50%; transform: translateX(-50%); }
        .compass-s { bottom: 4px; left: 50%; transform: translateX(-50%); }
        .compass-e { right: 4px; top: 50%; transform: translateY(-50%); }
        .compass-w { left: 4px; top: 50%; transform: translateY(-50%); }

        /* Data Sources Footer */
        .data-sources {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin-top: 1.5rem;
            padding: 1rem;
            background: var(--bg-card);
            border-radius: 12px;
            flex-wrap: wrap;
        }

        .data-source { display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; color: var(--text-secondary); }
        .source-status { width: 8px; height: 8px; border-radius: 50%; }
        .source-online { background: var(--accent-green); }
        .source-offline { background: var(--accent-red); }

        /* Responsive */
        @media (max-width: 1200px) { .cards-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 900px) {
            .hero { grid-template-columns: 1fr; }
            .cards-grid { grid-template-columns: repeat(2, 1fr); }
            .quick-stats { grid-template-columns: repeat(3, 1fr); }
        }
        @media (max-width: 600px) {
            .cards-grid { grid-template-columns: 1fr; }
            .detail-card.wide { grid-column: span 1; }
            .quick-stats { grid-template-columns: repeat(2, 1fr); }
            .forecast-day { min-width: 100px; }
        }

        .loading { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" style="
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #1a1a2e 100%);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    ">
        <div style="font-size: 4rem; margin-bottom: 1rem;">üìç</div>
        <div style="font-size: 1.5rem; color: #fff; margin-bottom: 0.5rem;">Detecting Your Location...</div>
        <div style="font-size: 0.9rem; color: #a0a0b8;">Please allow location access when prompted</div>
        <div style="margin-top: 2rem;">
            <div style="width: 200px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden;">
                <div style="width: 30%; height: 100%; background: #4a9eff; border-radius: 2px; animation: loading 1.5s ease-in-out infinite;"></div>
            </div>
        </div>
        <button onclick="skipDetection()" style="
            margin-top: 2rem;
            background: transparent;
            border: 1px solid #3a3a5c;
            color: #a0a0b8;
            padding: 0.5rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
        ">Skip - Use Default Location</button>
    </div>
    <style>
        @keyframes loading {
            0% { transform: translateX(-100%); }
            50% { transform: translateX(250%); }
            100% { transform: translateX(-100%); }
        }
    </style>

    <div class="dashboard">
        <!-- Header -->
        <header class="header">
            <div class="location-section">
                <div class="location">
                    <span class="location-pin">üìç</span>
                    <span id="locationName">Little Rock, AR</span>
                </div>
                <select class="location-select" id="locationSelect" onchange="changeLocation()">
                    <optgroup label="üìç Current Location">
                        <option value="auto">Use My Location</option>
                    </optgroup>
                    <optgroup label="üá∫üá∏ US State Capitals">
                        <option value="32.377,-86.300|Montgomery, AL">Montgomery, Alabama</option>
                        <option value="58.302,-134.420|Juneau, AK">Juneau, Alaska</option>
                        <option value="33.448,-112.074|Phoenix, AZ">Phoenix, Arizona</option>
                        <option value="34.746,-92.290|Little Rock, AR">Little Rock, Arkansas</option>
                        <option value="38.576,-121.494|Sacramento, CA">Sacramento, California</option>
                        <option value="39.739,-104.990|Denver, CO">Denver, Colorado</option>
                        <option value="41.764,-72.682|Hartford, CT">Hartford, Connecticut</option>
                        <option value="39.158,-75.524|Dover, DE">Dover, Delaware</option>
                        <option value="30.438,-84.281|Tallahassee, FL">Tallahassee, Florida</option>
                        <option value="33.749,-84.388|Atlanta, GA">Atlanta, Georgia</option>
                        <option value="21.307,-157.858|Honolulu, HI">Honolulu, Hawaii</option>
                        <option value="43.617,-116.200|Boise, ID">Boise, Idaho</option>
                        <option value="39.798,-89.654|Springfield, IL">Springfield, Illinois</option>
                        <option value="39.768,-86.162|Indianapolis, IN">Indianapolis, Indiana</option>
                        <option value="41.591,-93.604|Des Moines, IA">Des Moines, Iowa</option>
                        <option value="39.048,-95.678|Topeka, KS">Topeka, Kansas</option>
                        <option value="38.187,-84.875|Frankfort, KY">Frankfort, Kentucky</option>
                        <option value="30.457,-91.187|Baton Rouge, LA">Baton Rouge, Louisiana</option>
                        <option value="44.307,-69.782|Augusta, ME">Augusta, Maine</option>
                        <option value="38.979,-76.491|Annapolis, MD">Annapolis, Maryland</option>
                        <option value="42.358,-71.064|Boston, MA">Boston, Massachusetts</option>
                        <option value="42.733,-84.555|Lansing, MI">Lansing, Michigan</option>
                        <option value="44.955,-93.102|St. Paul, MN">St. Paul, Minnesota</option>
                        <option value="32.303,-90.182|Jackson, MS">Jackson, Mississippi</option>
                        <option value="38.579,-92.173|Jefferson City, MO">Jefferson City, Missouri</option>
                        <option value="46.586,-112.018|Helena, MT">Helena, Montana</option>
                        <option value="40.808,-96.699|Lincoln, NE">Lincoln, Nebraska</option>
                        <option value="39.164,-119.766|Carson City, NV">Carson City, Nevada</option>
                        <option value="43.206,-71.538|Concord, NH">Concord, New Hampshire</option>
                        <option value="40.221,-74.756|Trenton, NJ">Trenton, New Jersey</option>
                        <option value="35.682,-105.940|Santa Fe, NM">Santa Fe, New Mexico</option>
                        <option value="42.653,-73.757|Albany, NY">Albany, New York</option>
                        <option value="35.780,-78.639|Raleigh, NC">Raleigh, North Carolina</option>
                        <option value="46.825,-100.779|Bismarck, ND">Bismarck, North Dakota</option>
                        <option value="39.961,-83.003|Columbus, OH">Columbus, Ohio</option>
                        <option value="35.492,-97.503|Oklahoma City, OK">Oklahoma City, Oklahoma</option>
                        <option value="44.938,-123.030|Salem, OR">Salem, Oregon</option>
                        <option value="40.264,-76.884|Harrisburg, PA">Harrisburg, Pennsylvania</option>
                        <option value="41.824,-71.413|Providence, RI">Providence, Rhode Island</option>
                        <option value="34.000,-81.035|Columbia, SC">Columbia, South Carolina</option>
                        <option value="44.368,-100.336|Pierre, SD">Pierre, South Dakota</option>
                        <option value="36.166,-86.784|Nashville, TN">Nashville, Tennessee</option>
                        <option value="30.275,-97.740|Austin, TX">Austin, Texas</option>
                        <option value="40.778,-111.888|Salt Lake City, UT">Salt Lake City, Utah</option>
                        <option value="44.259,-72.576|Montpelier, VT">Montpelier, Vermont</option>
                        <option value="37.538,-77.434|Richmond, VA">Richmond, Virginia</option>
                        <option value="47.035,-122.905|Olympia, WA">Olympia, Washington</option>
                        <option value="38.336,-81.612|Charleston, WV">Charleston, West Virginia</option>
                        <option value="43.074,-89.384|Madison, WI">Madison, Wisconsin</option>
                        <option value="41.140,-104.820|Cheyenne, WY">Cheyenne, Wyoming</option>
                    </optgroup>
                    <optgroup label="üåç World Capitals">
                        <option value="51.507,-0.128|London, UK">London, United Kingdom</option>
                        <option value="48.857,2.352|Paris, France">Paris, France</option>
                        <option value="52.520,13.405|Berlin, Germany">Berlin, Germany</option>
                        <option value="41.902,12.496|Rome, Italy">Rome, Italy</option>
                        <option value="40.417,-3.704|Madrid, Spain">Madrid, Spain</option>
                        <option value="55.756,37.617|Moscow, Russia">Moscow, Russia</option>
                        <option value="35.690,139.692|Tokyo, Japan">Tokyo, Japan</option>
                        <option value="39.904,116.407|Beijing, China">Beijing, China</option>
                        <option value="28.614,77.209|New Delhi, India">New Delhi, India</option>
                        <option value="-33.865,151.210|Sydney, Australia">Sydney, Australia</option>
                        <option value="-23.550,-46.633|Sao Paulo, Brazil">Sao Paulo, Brazil</option>
                        <option value="19.433,-99.133|Mexico City, Mexico">Mexico City, Mexico</option>
                        <option value="45.421,-75.690|Ottawa, Canada">Ottawa, Canada</option>
                        <option value="-34.604,-58.382|Buenos Aires, Argentina">Buenos Aires, Argentina</option>
                        <option value="30.044,31.236|Cairo, Egypt">Cairo, Egypt</option>
                        <option value="-1.286,36.817|Nairobi, Kenya">Nairobi, Kenya</option>
                        <option value="-33.925,18.424|Cape Town, South Africa">Cape Town, South Africa</option>
                        <option value="1.352,103.820|Singapore">Singapore</option>
                        <option value="37.566,126.978|Seoul, South Korea">Seoul, South Korea</option>
                        <option value="13.756,100.502|Bangkok, Thailand">Bangkok, Thailand</option>
                    </optgroup>
                </select>
                <div class="last-updated">Last updated: <span id="lastUpdated">--</span></div>
            </div>
            <div class="header-buttons">
                <button class="btn" id="themeBtn" onclick="toggleTheme()">‚òÄÔ∏è Light</button>
                <button class="btn" id="geoBtn" onclick="detectLocation()">üìç Detect Location</button>
                <button class="btn" id="refreshBtn" onclick="refreshData()">‚Üª Refresh</button>
            </div>
        </header>

        <!-- Hero Section -->
        <section class="hero">
            <div class="current-weather">
                <div class="weather-main">
                    <div class="weather-icon" id="weatherIcon">üå§Ô∏è</div>
                    <div>
                        <div class="temp-display"><span id="currentTemp">--</span><span class="unit">¬∞F</span></div>
                        <div class="condition" id="condition">Loading...</div>
                        <div class="feels-like">Feels like <span id="feelsLike">--</span>¬∞</div>
                    </div>
                </div>
                <div class="weather-summary" id="weatherSummary">Detecting location...</div>
                <div class="quick-stats">
                    <div class="quick-stat">
                        <div class="quick-stat-label">Wind</div>
                        <div class="quick-stat-value"><span id="windSpeed">--</span> mph</div>
                    </div>
                    <div class="quick-stat">
                        <div class="quick-stat-label">Humidity</div>
                        <div class="quick-stat-value"><span id="humidity">--</span>%</div>
                    </div>
                    <div class="quick-stat">
                        <div class="quick-stat-label">Pressure</div>
                        <div class="quick-stat-value"><span id="pressure">--</span> mb</div>
                    </div>
                    <div class="quick-stat">
                        <div class="quick-stat-label">Dew Point</div>
                        <div class="quick-stat-value"><span id="dewpoint">--</span>¬∞</div>
                    </div>
                    <div class="quick-stat">
                        <div class="quick-stat-label">Visibility</div>
                        <div class="quick-stat-value"><span id="visibility">--</span> mi</div>
                    </div>
                </div>
            </div>

            <div class="dso-risk">
                <div class="risk-header">
                    <span class="risk-title">DSO Severe Weather Risk</span>
                    <span class="risk-badge risk-minimal" id="riskBadge">MINIMAL</span>
                </div>
                <div class="risk-level" id="riskLevel" style="color: var(--accent-blue);">MINIMAL</div>
                <div class="risk-summary" id="riskSummary">Low severe weather threat</div>

                <!-- 6-Month Risk Outlook -->
                <div class="month-risk-strip" id="monthRiskStrip">
                    <!-- Populated by JS -->
                </div>

                <div class="gauge-container">
                    <div class="gauge-fill gauge-gradient" id="riskGauge" style="width: 10%;"></div>
                </div>
                <div class="dso-indices">
                    <div class="dso-index">
                        <div class="dso-index-value" id="dsoP">--</div>
                        <div class="dso-index-label">P (Probability)</div>
                    </div>
                    <div class="dso-index">
                        <div class="dso-index-value" id="dsoV">--</div>
                        <div class="dso-index-label">V (Volatility)</div>
                    </div>
                    <div class="dso-index">
                        <div class="dso-index-value" id="dsoD">--</div>
                        <div class="dso-index-label">D (Danger)</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 7-Day Forecast Strip -->
        <section class="forecast-strip" id="forecastStrip">
            <!-- Populated by JS -->
        </section>

        <!-- Detail Cards Grid -->
        <section class="cards-grid">
            <div class="detail-card">
                <div class="card-header">
                    <span class="card-title">Wind</span>
                    <span class="card-icon">üí®</span>
                </div>
                <div class="wind-compass">
                    <span class="compass-label compass-n">N</span>
                    <span class="compass-label compass-s">S</span>
                    <span class="compass-label compass-e">E</span>
                    <span class="compass-label compass-w">W</span>
                    <div class="compass-arrow" id="windArrow" style="transform: translate(-50%, -100%) rotate(0deg);"></div>
                </div>
                <div style="text-align: center;">
                    <div class="card-value"><span id="windSpeedCard">--</span> <span class="unit">mph</span></div>
                    <div class="card-status"><span>From <span id="windDir">--</span></span></div>
                </div>
                <div class="card-description" id="windDesc">--</div>
            </div>

            <div class="detail-card">
                <div class="card-header">
                    <span class="card-title">Humidity</span>
                    <span class="card-icon">üíß</span>
                </div>
                <div class="card-value"><span id="humidityCard">--</span><span class="unit">%</span></div>
                <div class="gauge-container">
                    <div class="gauge-fill" id="humidityGauge" style="width: 0%; background: var(--accent-blue);"></div>
                </div>
                <div class="card-status">
                    <span class="status-dot status-good" id="humidityDot"></span>
                    <span id="humidityStatus">--</span>
                </div>
                <div class="card-description">Dew point: <span id="dewpointCard">--</span>¬∞F</div>
            </div>

            <div class="detail-card">
                <div class="card-header">
                    <span class="card-title">Pressure</span>
                    <span class="card-icon">üìä</span>
                </div>
                <div class="card-value"><span id="pressureCard">--</span> <span class="unit">mb</span></div>
                <div class="gauge-container">
                    <div class="gauge-fill" id="pressureGauge" style="width: 50%; background: var(--accent-green);"></div>
                </div>
                <div class="card-status">
                    <span class="status-dot" id="pressureDot"></span>
                    <span id="pressureTrend">--</span>
                </div>
                <div class="card-description" id="pressureDesc">--</div>
            </div>

            <div class="detail-card">
                <div class="card-header">
                    <span class="card-title">Gulf SST</span>
                    <span class="card-icon">üåä</span>
                </div>
                <div class="card-value"><span id="gulfSST">--</span><span class="unit">¬∞C</span></div>
                <div class="gauge-container">
                    <div class="gauge-fill gauge-gradient" id="sstGauge" style="width: 0%;"></div>
                </div>
                <div class="card-status">
                    <span class="status-dot" id="sstDot"></span>
                    <span id="sstStatus">--</span>
                </div>
                <div class="card-description">E-Fuel: <span id="eFuelValue">--</span></div>
            </div>

            <div class="detail-card">
                <div class="card-header">
                    <span class="card-title">Catalyst (dŒ∏/dt)</span>
                    <span class="card-icon">üåÄ</span>
                </div>
                <div class="card-value"><span id="catalyst">--</span></div>
                <div class="gauge-container">
                    <div class="gauge-fill" id="catalystGauge" style="width: 0%; background: var(--accent-gold);"></div>
                </div>
                <div class="card-status"><span id="catalystPhase">--</span></div>
                <div class="card-description"><span id="daysToEquinox">--</span> days to equinox</div>
            </div>

            <div class="detail-card">
                <div class="card-header">
                    <span class="card-title">Solar Angle</span>
                    <span class="card-icon">‚òÄÔ∏è</span>
                </div>
                <div class="card-value"><span id="solarAngle">--</span><span class="unit">¬∞</span></div>
                <div class="gauge-container">
                    <div class="gauge-fill" id="solarGauge" style="width: 0%; background: var(--accent-orange);"></div>
                </div>
                <div class="card-status"><span id="solarStatus">--</span></div>
                <div class="card-description">Energy input factor</div>
            </div>

            <div class="detail-card">
                <div class="card-header">
                    <span class="card-title">CAPE</span>
                    <span class="card-icon">‚ö°</span>
                </div>
                <div class="card-value"><span id="cape">--</span> <span class="unit">J/kg</span></div>
                <div class="gauge-container">
                    <div class="gauge-fill gauge-gradient" id="capeGauge" style="width: 0%;"></div>
                </div>
                <div class="card-status">
                    <span class="status-dot" id="capeDot"></span>
                    <span id="capeStatus">--</span>
                </div>
                <div class="card-description">Convective Available Potential Energy</div>
            </div>

            <div class="detail-card">
                <div class="card-header">
                    <span class="card-title">Gradient (‚àÇE/‚àÇœÜ)</span>
                    <span class="card-icon">üìà</span>
                </div>
                <div class="card-value"><span id="gradient">--</span></div>
                <div class="gauge-container">
                    <div class="gauge-fill" id="gradientGauge" style="width: 0%; background: var(--accent-purple);"></div>
                </div>
                <div class="card-status"><span id="gradientStatus">--</span></div>
                <div class="card-description">Air mass collision intensity</div>
            </div>
        </section>

        <footer class="data-sources">
            <div class="data-source">
                <span class="source-status" id="sourceSurface"></span>
                <span>Surface (NWS)</span>
            </div>
            <div class="data-source">
                <span class="source-status" id="sourceSST"></span>
                <span>Gulf SST (Open-Meteo)</span>
            </div>
            <div class="data-source">
                <span class="source-status" id="sourceAtmo"></span>
                <span>Atmospheric (Open-Meteo)</span>
            </div>
        </footer>
    </div>

    <script src="noaaWeatherService.js"></script>

    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // LOCATION STATE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let currentLocation = {
            lat: 34.7465,
            lon: -92.2896,
            name: 'Little Rock, AR'
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // DSO WEATHER ENGINE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        class DSOEngine {
            constructor() {
                this.EARTH_TILT = 23.44;
                this.DAYS_PER_YEAR = 365.25;
                this.SPRING_EQUINOX_DOY = 80;
            }

            getDayOfYear(date = new Date()) {
                const start = new Date(date.getFullYear(), 0, 0);
                return Math.floor((date - start) / (1000 * 60 * 60 * 24));
            }

            getCatalyst(dayOfYear) {
                const shifted = dayOfYear - this.SPRING_EQUINOX_DOY;
                return Math.abs(Math.cos((2 * Math.PI * shifted) / this.DAYS_PER_YEAR));
            }

            getSolarAngle(lat, dayOfYear) {
                const latRad = (lat * Math.PI) / 180;
                const declination = this.EARTH_TILT * Math.sin((2 * Math.PI * (dayOfYear - 81)) / this.DAYS_PER_YEAR);
                const decRad = (declination * Math.PI) / 180;
                const solarElevation = Math.asin(
                    Math.sin(latRad) * Math.sin(decRad) + Math.cos(latRad) * Math.cos(decRad)
                );
                return Math.max(0, Math.sin(solarElevation));
            }

            // Calculate fuel based on latitude (distance from Gulf)
            getFuel(lat) {
                // Gulf is ~25¬∞N, fuel decreases with distance
                const gulfLat = 25;
                const distance = Math.abs(lat - gulfLat);
                if (distance < 5) return 0.95;
                if (distance < 10) return 0.90;
                if (distance < 15) return 0.85;
                if (distance < 20) return 0.75;
                if (distance < 30) return 0.60;
                return Math.max(0.2, 0.60 - (distance - 30) * 0.01);
            }

            // Calculate gradient based on latitude (Dixie/Tornado Alley zones)
            getGradient(lat) {
                // Peak gradient zone: 33-38¬∞N (Tornado/Dixie Alley)
                if (lat >= 33 && lat <= 38) return 0.95;
                if (lat >= 30 && lat < 33) return 0.80;
                if (lat > 38 && lat <= 42) return 0.85;
                if (lat > 42 && lat <= 48) return 0.70;
                return Math.max(0.3, 0.60 - Math.abs(lat - 35) * 0.02);
            }

            getProbability(fuel, catalyst, solar) {
                return fuel * catalyst * solar;
            }

            getVolatility(gradient, catalyst, solar) {
                return gradient * catalyst * solar;
            }

            getDanger(fuel, gradient, catalyst, solar) {
                return fuel * gradient * Math.pow(catalyst, 2) * Math.pow(solar, 2);
            }

            classifyWeather(lat, dayOfYear, realTimeData = null) {
                const catalyst = this.getCatalyst(dayOfYear);
                const solar = this.getSolarAngle(lat, dayOfYear);
                const fuel = this.getFuel(lat);
                const gradient = this.getGradient(lat);

                let effectiveFuel = fuel;
                if (realTimeData?.humidity != null) {
                    effectiveFuel = fuel * (realTimeData.humidity / 100);
                }

                const P = this.getProbability(effectiveFuel, catalyst, solar);
                const V = this.getVolatility(gradient, catalyst, solar);
                const D = this.getDanger(effectiveFuel, gradient, catalyst, solar);

                let condition, icon, description;

                // Classification based on P (probability) as primary driver
                if (D > 0.15 && V > 0.3) {
                    condition = 'Severe Storms'; icon = '‚õàÔ∏è'; description = 'High severe weather potential';
                } else if (P >= 0.65) {
                    condition = 'Rain'; icon = 'üåßÔ∏è'; description = 'Rain expected';
                } else if (P >= 0.25) {
                    condition = 'Scattered Showers'; icon = 'üå¶Ô∏è'; description = 'Scattered showers possible';
                } else if (P >= 0.15) {
                    condition = 'Partly Cloudy'; icon = '‚õÖ'; description = 'Partly cloudy skies';
                } else if (P >= 0.08) {
                    condition = 'Mostly Sunny'; icon = 'üå§Ô∏è'; description = 'Mostly sunny skies';
                } else {
                    condition = 'Sunny'; icon = '‚òÄÔ∏è'; description = 'Clear and sunny';
                }

                let riskLevel, riskColor;
                if (D > 0.2) { riskLevel = 'HIGH'; riskColor = 'var(--accent-red)'; }
                else if (D > 0.1) { riskLevel = 'MODERATE'; riskColor = 'var(--accent-orange)'; }
                else if (D > 0.05) { riskLevel = 'LOW'; riskColor = 'var(--accent-green)'; }
                else { riskLevel = 'MINIMAL'; riskColor = 'var(--accent-blue)'; }

                return {
                    condition, icon, description, riskLevel, riskColor,
                    factors: { catalyst, solar, fuel: effectiveFuel, gradient },
                    indices: { P, V, D }
                };
            }

            get7DayForecast(lat) {
                const forecasts = [];
                const today = new Date();
                for (let i = 0; i < 7; i++) {
                    const date = new Date(today);
                    date.setDate(date.getDate() + i);
                    const doy = this.getDayOfYear(date);
                    const forecast = this.classifyWeather(lat, doy);
                    forecast.date = date;
                    forecast.dayName = i === 0 ? 'Today' : date.toLocaleDateString('en-US', { weekday: 'short' });
                    forecast.dateNum = date.getDate();
                    forecasts.push(forecast);
                }
                return forecasts;
            }
        }

        const dsoEngine = new DSOEngine();
        let weatherService = null;

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // GEOLOCATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function detectLocation() {
            const btn = document.getElementById('geoBtn');
            btn.textContent = 'üìç Detecting...';
            btn.disabled = true;

            if (!navigator.geolocation) {
                alert('Geolocation not supported by your browser');
                btn.textContent = 'üìç Detect Location';
                btn.disabled = false;
                return;
            }

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    console.log('Got position:', position.coords);
                    currentLocation.lat = position.coords.latitude;
                    currentLocation.lon = position.coords.longitude;

                    // Try to get location name from reverse geocoding
                    try {
                        const resp = await fetch(`https://api.weather.gov/points/${currentLocation.lat.toFixed(4)},${currentLocation.lon.toFixed(4)}`);
                        if (resp.ok) {
                            const data = await resp.json();
                            const city = data.properties?.relativeLocation?.properties?.city || '';
                            const state = data.properties?.relativeLocation?.properties?.state || '';
                            currentLocation.name = city && state ? `${city}, ${state}` : `${currentLocation.lat.toFixed(2)}¬∞N, ${Math.abs(currentLocation.lon).toFixed(2)}¬∞W`;
                        }
                    } catch (e) {
                        currentLocation.name = `${currentLocation.lat.toFixed(2)}¬∞N, ${Math.abs(currentLocation.lon).toFixed(2)}¬∞W`;
                    }

                    document.getElementById('locationSelect').value = 'auto';
                    btn.textContent = 'üìç Detect Location';
                    btn.disabled = false;
                    await initWeatherService();
                    refreshData();
                },
                (error) => {
                    console.error('Geolocation error:', error);
                    alert('Could not detect location: ' + error.message);
                    btn.textContent = 'üìç Detect Location';
                    btn.disabled = false;
                },
                {
                    enableHighAccuracy: false,
                    timeout: 10000,
                    maximumAge: 300000
                }
            );
        }

        async function changeLocation() {
            const select = document.getElementById('locationSelect');
            const value = select.value;

            if (value === 'auto') {
                detectLocation();
                return;
            }

            const [coords, name] = value.split('|');
            const [lat, lon] = coords.split(',').map(Number);

            currentLocation = { lat, lon, name };
            await initWeatherService();
            refreshData();
        }

        async function initWeatherService() {
            weatherService = new DSOWeatherService({
                location: {
                    name: currentLocation.name,
                    lat: currentLocation.lat,
                    lon: currentLocation.lon
                }
            });
            // Find the nearest weather station for this location
            await weatherService.setLocationFromCoords(currentLocation.lat, currentLocation.lon);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // DATA REFRESH
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function refreshData() {
            const btn = document.getElementById('refreshBtn');
            btn.textContent = '‚Üª Loading...';
            btn.disabled = true;

            document.getElementById('locationName').textContent = currentLocation.name;

            try {
                if (weatherService) {
                    const vars = await weatherService.getWeatherVariables();
                    updateDashboard(vars);
                } else {
                    updateDashboard(null);
                }
            } catch (error) {
                console.error('Failed to fetch weather data:', error);
                updateDashboard(null);
            }

            // Always build forecast strip (even if weather service fails)
            try {
                buildForecastStrip();
                buildMonthRiskStrip();
            } catch (e) {
                console.error('Forecast strip error:', e);
            }

            btn.textContent = '‚Üª Refresh';
            btn.disabled = false;
        }

        function getRaw(obj) {
            if (!obj) return null;
            if (obj.raw !== undefined) return obj.raw;
            if (obj.value === 'NO DATA') return null;
            const num = parseFloat(obj.value);
            return isNaN(num) ? null : num;
        }

        function formatValue(val, decimals = 0, fallback = '--') {
            if (val === null || val === undefined || isNaN(val)) return fallback;
            return decimals > 0 ? val.toFixed(decimals) : Math.round(val).toString();
        }

        function updateDashboard(vars) {
            document.getElementById('lastUpdated').textContent = new Date().toLocaleString();

            const tempC = vars ? getRaw(vars.thermalVariance?.surfaceTemp) : null;
            const tempF = tempC !== null ? tempC * 9/5 + 32 : null;
            const dewpointC = vars ? getRaw(vars.humidity?.dewpoint) : null;
            const dewpointF = dewpointC !== null ? dewpointC * 9/5 + 32 : null;
            const rh = vars ? getRaw(vars.humidity?.relativeHumidity) : null;
            const windSpd = vars ? getRaw(vars.windPattern?.speed) : null;
            const windDir = vars ? getRaw(vars.windPattern?.direction) : null;
            const pressure = vars ? getRaw(vars.angleOfAttack?.pressure) : null;
            const gulfSST = vars ? getRaw(vars.eFuel?.gulfSST) : null;
            const eFuel = vars ? getRaw(vars.eFuel?.value) : null;
            const gradientVal = vars ? getRaw(vars.gradient?.value) : null;
            const catalyst = vars ? getRaw(vars.catalyst?.value) : null;
            const solarAngle = vars ? getRaw(vars.solarAngle?.value) : null;
            const solarDeg = vars ? getRaw(vars.solarAngle?.incidenceDegrees) : null;
            const cape = vars ? getRaw(vars.energyDispersal?.cape) : null;

            // DSO prediction for today
            const todayDSO = dsoEngine.classifyWeather(currentLocation.lat, dsoEngine.getDayOfYear(), { humidity: rh });

            document.getElementById('currentTemp').textContent = formatValue(tempF);
            document.getElementById('condition').textContent = todayDSO.condition;
            document.getElementById('feelsLike').textContent = formatValue(tempF);
            document.getElementById('weatherIcon').textContent = todayDSO.icon;
            document.getElementById('weatherSummary').textContent = `${todayDSO.description}. Current: ${formatValue(tempF)}¬∞F with ${formatValue(rh)}% humidity.`;

            document.getElementById('windSpeed').textContent = formatValue(windSpd, 1);
            document.getElementById('humidity').textContent = formatValue(rh);
            document.getElementById('pressure').textContent = formatValue(pressure, 1);
            document.getElementById('dewpoint').textContent = formatValue(dewpointF);
            document.getElementById('visibility').textContent = '--';

            // DSO Risk
            const P = todayDSO.indices.P;
            const V = todayDSO.indices.V;
            const D = todayDSO.indices.D;

            let riskLevel = todayDSO.riskLevel;
            let riskColor = todayDSO.riskColor;
            let riskClass = 'risk-' + riskLevel.toLowerCase();
            let riskPct = riskLevel === 'HIGH' ? 90 : riskLevel === 'MODERATE' ? 60 : riskLevel === 'LOW' ? 35 : 10;

            document.getElementById('riskLevel').textContent = riskLevel;
            document.getElementById('riskLevel').style.color = riskColor;
            document.getElementById('riskBadge').textContent = riskLevel;
            document.getElementById('riskBadge').className = 'risk-badge ' + riskClass;
            document.getElementById('riskGauge').style.width = riskPct + '%';
            document.getElementById('riskSummary').textContent = todayDSO.description;

            document.getElementById('dsoP').textContent = P.toFixed(3);
            document.getElementById('dsoV').textContent = V.toFixed(3);
            document.getElementById('dsoD').textContent = D.toFixed(4);

            // Detail cards
            document.getElementById('windSpeedCard').textContent = formatValue(windSpd, 1);
            document.getElementById('windDir').textContent = windDir !== null && vars ? vars.windPattern?.directionCardinal || '--' : '--';
            if (windDir !== null) {
                document.getElementById('windArrow').style.transform = `translate(-50%, -100%) rotate(${windDir}deg)`;
            }
            document.getElementById('windDesc').textContent = windSpd !== null ? (windSpd > 20 ? 'Strong winds' : windSpd > 10 ? 'Moderate breeze' : 'Light winds') : '--';

            document.getElementById('humidityCard').textContent = formatValue(rh);
            document.getElementById('humidityGauge').style.width = (rh || 0) + '%';
            document.getElementById('humidityStatus').textContent = rh !== null ? (rh > 70 ? 'High' : rh > 40 ? 'Comfortable' : 'Dry') : '--';
            document.getElementById('dewpointCard').textContent = formatValue(dewpointF);

            document.getElementById('pressureCard').textContent = formatValue(pressure, 1);
            const pressureNorm = pressure !== null ? Math.min(100, Math.max(0, (pressure - 980) / 60 * 100)) : 50;
            document.getElementById('pressureGauge').style.width = pressureNorm + '%';
            document.getElementById('pressureTrend').textContent = pressure !== null ? (pressure > 1013 ? 'Rising' : 'Falling') : '--';
            document.getElementById('pressureDesc').textContent = pressure !== null ? (pressure > 1020 ? 'High pressure - stable' : pressure < 1005 ? 'Low pressure - unsettled' : 'Normal') : '--';

            document.getElementById('gulfSST').textContent = formatValue(gulfSST, 1);
            const sstNorm = gulfSST !== null ? Math.min(100, Math.max(0, (gulfSST - 15) / 20 * 100)) : 0;
            document.getElementById('sstGauge').style.width = sstNorm + '%';
            document.getElementById('sstStatus').textContent = gulfSST !== null ? (gulfSST > 26 ? 'Warm - high fuel' : gulfSST > 22 ? 'Moderate' : 'Cool') : '--';
            document.getElementById('eFuelValue').textContent = formatValue(eFuel, 3);

            document.getElementById('catalyst').textContent = todayDSO.factors.catalyst.toFixed(3);
            document.getElementById('catalystGauge').style.width = (todayDSO.factors.catalyst * 100) + '%';
            document.getElementById('catalystPhase').textContent = vars?.catalyst?.phase || '--';
            document.getElementById('daysToEquinox').textContent = vars?.catalyst?.daysToEquinox || '--';

            document.getElementById('solarAngle').textContent = formatValue(solarDeg, 1);
            document.getElementById('solarGauge').style.width = (todayDSO.factors.solar * 100) + '%';
            document.getElementById('solarStatus').textContent = todayDSO.factors.solar > 0.7 ? 'High energy' : todayDSO.factors.solar > 0.4 ? 'Moderate' : 'Low energy';

            document.getElementById('cape').textContent = formatValue(cape, 0);
            const capeNorm = cape !== null ? Math.min(100, cape / 3000 * 100) : 0;
            document.getElementById('capeGauge').style.width = capeNorm + '%';
            document.getElementById('capeStatus').textContent = cape !== null ? (cape > 2000 ? 'Extreme' : cape > 1000 ? 'Strong' : cape > 500 ? 'Moderate' : 'Weak') : '--';
            document.getElementById('capeDot').className = 'status-dot ' + (cape > 1500 ? 'status-poor' : cape > 500 ? 'status-moderate' : 'status-good');

            document.getElementById('gradient').textContent = todayDSO.factors.gradient.toFixed(3);
            document.getElementById('gradientGauge').style.width = (todayDSO.factors.gradient * 100) + '%';
            document.getElementById('gradientStatus').textContent = todayDSO.factors.gradient > 0.7 ? 'Strong collision' : todayDSO.factors.gradient > 0.4 ? 'Moderate' : 'Weak';

            const meta = vars?.metadata?.dataSources || {};
            document.getElementById('sourceSurface').className = 'source-status ' + (meta.surface ? 'source-online' : 'source-offline');
            document.getElementById('sourceSST').className = 'source-status ' + (meta.gulfBuoys ? 'source-online' : 'source-offline');
            document.getElementById('sourceAtmo').className = 'source-status ' + (meta.atmospheric ? 'source-online' : 'source-offline');
        }

        function buildForecastStrip() {
            const strip = document.getElementById('forecastStrip');
            strip.innerHTML = '';

            const forecasts = dsoEngine.get7DayForecast(currentLocation.lat);

            forecasts.forEach((forecast, i) => {
                const card = document.createElement('div');
                card.className = 'forecast-day' + (i === 0 ? ' active' : '');

                const rainChance = Math.round(forecast.indices.P * 100);

                card.innerHTML = `
                    <div class="forecast-day-name">${forecast.dayName}</div>
                    <div class="forecast-day-date">${forecast.dateNum}</div>
                    <div class="forecast-icon">${forecast.icon}</div>
                    <div class="forecast-condition">${forecast.condition}</div>
                    <div class="forecast-rain-chance">${rainChance}% chance of rain</div>
                    <div class="forecast-indices">
                        <div class="forecast-index">
                            <span class="forecast-index-label">P</span>
                            <span class="forecast-index-value">${forecast.indices.P.toFixed(2)}</span>
                        </div>
                        <div class="forecast-index">
                            <span class="forecast-index-label">V</span>
                            <span class="forecast-index-value">${forecast.indices.V.toFixed(2)}</span>
                        </div>
                        <div class="forecast-index">
                            <span class="forecast-index-label">D</span>
                            <span class="forecast-index-value">${forecast.indices.D.toFixed(3)}</span>
                        </div>
                    </div>
                `;

                card.onclick = () => showDayDetails(forecast, i);
                strip.appendChild(card);
            });
        }

        // Build 6-month risk outlook
        function buildMonthRiskStrip() {
            const strip = document.getElementById('monthRiskStrip');
            strip.innerHTML = '';

            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const today = new Date();
            const currentMonth = today.getMonth();

            // Calculate average risk for each of the next 6 months
            for (let i = 0; i < 6; i++) {
                const monthIndex = (currentMonth + i) % 12;
                const monthName = months[monthIndex];

                // Sample middle of each month for DSO calculation
                const year = today.getFullYear() + (currentMonth + i >= 12 ? 1 : 0);
                const sampleDate = new Date(year, monthIndex, 15);
                const doy = dsoEngine.getDayOfYear(sampleDate);

                // Get DSO factors for this month
                const catalyst = dsoEngine.getCatalyst(doy);
                const solar = dsoEngine.getSolarAngle(currentLocation.lat, doy);
                const fuel = dsoEngine.getFuel(currentLocation.lat);
                const gradient = dsoEngine.getGradient(currentLocation.lat);

                const P = fuel * catalyst * solar;
                const V = gradient * catalyst * solar;
                const D = fuel * gradient * Math.pow(catalyst, 2) * Math.pow(solar, 2);

                // Determine risk level and color
                let meterClass, riskLabel;
                if (D > 0.12) {
                    meterClass = 'meter-red';
                    riskLabel = 'HIGH';
                } else if (D > 0.06) {
                    meterClass = 'meter-yellow';
                    riskLabel = 'MODERATE';
                } else {
                    meterClass = 'meter-green';
                    riskLabel = 'LOW';
                }

                const card = document.createElement('div');
                card.className = 'month-risk-card';
                card.title = `${months[monthIndex]} ${year}\nRisk: ${riskLabel}\nP: ${(P * 100).toFixed(0)}%\nV: ${V.toFixed(2)}\nD: ${D.toFixed(3)}\nCatalyst: ${catalyst.toFixed(2)}`;
                card.innerHTML = `
                    <div class="month-risk-name">${monthName}</div>
                    <div class="month-risk-meter ${meterClass}"></div>
                `;
                strip.appendChild(card);
            }
        }

        function showDayDetails(forecast, index) {
            document.querySelectorAll('.forecast-day').forEach((el, i) => {
                el.classList.toggle('active', i === index);
            });

            document.getElementById('weatherIcon').textContent = forecast.icon;
            document.getElementById('condition').textContent = forecast.condition;
            document.getElementById('weatherSummary').textContent = `${forecast.description}. DSO Risk: ${forecast.riskLevel}`;

            document.getElementById('dsoP').textContent = forecast.indices.P.toFixed(3);
            document.getElementById('dsoV').textContent = forecast.indices.V.toFixed(3);
            document.getElementById('dsoD').textContent = forecast.indices.D.toFixed(4);

            document.getElementById('riskLevel').textContent = forecast.riskLevel;
            document.getElementById('riskLevel').style.color = forecast.riskColor;
            document.getElementById('riskBadge').textContent = forecast.riskLevel;
            document.getElementById('riskBadge').className = 'risk-badge risk-' + forecast.riskLevel.toLowerCase();

            const riskPct = forecast.riskLevel === 'HIGH' ? 90 : forecast.riskLevel === 'MODERATE' ? 60 : forecast.riskLevel === 'LOW' ? 35 : 10;
            document.getElementById('riskGauge').style.width = riskPct + '%';
            document.getElementById('riskSummary').textContent = forecast.description;

            document.getElementById('catalyst').textContent = forecast.factors.catalyst.toFixed(3);
            document.getElementById('catalystGauge').style.width = (forecast.factors.catalyst * 100) + '%';
            document.getElementById('solarAngle').textContent = (Math.asin(forecast.factors.solar) * 180 / Math.PI).toFixed(1);
            document.getElementById('solarGauge').style.width = (forecast.factors.solar * 100) + '%';
            document.getElementById('gradient').textContent = forecast.factors.gradient.toFixed(3);
            document.getElementById('gradientGauge').style.width = (forecast.factors.gradient * 100) + '%';
        }

        // Theme toggle
        function toggleTheme() {
            const html = document.documentElement;
            const btn = document.getElementById('themeBtn');

            if (html.getAttribute('data-theme') === 'light') {
                html.removeAttribute('data-theme');
                btn.textContent = '‚òÄÔ∏è Light';
                localStorage.setItem('theme', 'dark');
            } else {
                html.setAttribute('data-theme', 'light');
                btn.textContent = 'üåô Dark';
                localStorage.setItem('theme', 'light');
            }
        }

        // Load saved theme on page ready
        function loadSavedTheme() {
            const saved = localStorage.getItem('theme');
            const btn = document.getElementById('themeBtn');
            if (saved === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
                if (btn) btn.textContent = 'üåô Dark';
            } else {
                document.documentElement.removeAttribute('data-theme');
                if (btn) btn.textContent = '‚òÄÔ∏è Light';
            }
        }
        loadSavedTheme();

        function hideOverlay() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.opacity = '0';
                overlay.style.transition = 'opacity 0.3s';
                setTimeout(() => overlay.remove(), 300);
            }
        }

        async function skipDetection() {
            hideOverlay();
            await initWeatherService();
            refreshData();
        }

        // Auto-detect location on page load
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    currentLocation.lat = position.coords.latitude;
                    currentLocation.lon = position.coords.longitude;

                    // Get location name
                    try {
                        const resp = await fetch(`https://api.weather.gov/points/${currentLocation.lat.toFixed(4)},${currentLocation.lon.toFixed(4)}`);
                        if (resp.ok) {
                            const data = await resp.json();
                            const city = data.properties?.relativeLocation?.properties?.city || '';
                            const state = data.properties?.relativeLocation?.properties?.state || '';
                            currentLocation.name = city && state ? `${city}, ${state}` : `${currentLocation.lat.toFixed(2)}¬∞, ${currentLocation.lon.toFixed(2)}¬∞`;
                        }
                    } catch (e) {
                        currentLocation.name = `${currentLocation.lat.toFixed(2)}¬∞, ${currentLocation.lon.toFixed(2)}¬∞`;
                    }

                    document.getElementById('locationSelect').value = 'auto';
                    hideOverlay();
                    await initWeatherService();
                    refreshData();
                },
                async (err) => {
                    console.log('Geolocation denied or failed:', err.message);
                    hideOverlay();
                    await initWeatherService();
                    refreshData();
                },
                { enableHighAccuracy: false, timeout: 10000, maximumAge: 300000 }
            );
        } else {
            // No geolocation support - just load default
            (async () => {
                hideOverlay();
                await initWeatherService();
                refreshData();
            })();
        }
    </script>
</body>
</html>
