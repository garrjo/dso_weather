<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSO Weather Intelligence | Arkansas</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --bg-elevated: #1a1a24;
            --border: #2a2a3a;
            --text-primary: #f0f0f5;
            --text-secondary: #8888aa;
            --text-muted: #555566;
            --accent-red: #ef4444;
            --accent-orange: #f97316;
            --accent-yellow: #eab308;
            --accent-green: #22c55e;
            --accent-blue: #3b82f6;
            --accent-purple: #a855f7;
            --accent-cyan: #06b6d4;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }
        .container { max-width: 1600px; margin: 0 auto; padding: 1.5rem; }
        
        /* Header */
        header {
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;
            margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border);
        }
        .logo { display: flex; align-items: center; gap: 1rem; }
        .logo-icon {
            width: 48px; height: 48px;
            background: linear-gradient(135deg, var(--accent-orange), var(--accent-red));
            border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;
        }
        .logo h1 { font-size: 1.4rem; font-weight: 700; }
        .logo span { color: var(--text-secondary); font-size: 0.8rem; display: block; }
        .controls { display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap; }
        select, input[type="date"] {
            background: var(--bg-elevated); border: 1px solid var(--border);
            color: var(--text-primary); padding: 0.6rem 0.9rem; border-radius: 8px;
            font-family: inherit; font-size: 0.85rem; cursor: pointer;
        }
        .btn {
            background: var(--accent-blue); border: none; color: white;
            padding: 0.6rem 1rem; border-radius: 8px; cursor: pointer; font-family: inherit;
            font-weight: 500; transition: background 0.2s;
        }
        .btn:hover { background: #2563eb; }
        
        /* Status bar */
        .status-bar {
            display: flex; gap: 1rem; align-items: center; margin-bottom: 1.5rem;
            padding: 0.75rem 1rem; background: var(--bg-card); border-radius: 10px;
            font-size: 0.8rem; flex-wrap: wrap;
        }
        .status-item { display: flex; align-items: center; gap: 0.4rem; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .status-dot.live { background: var(--accent-green); animation: pulse 2s infinite; }
        .status-dot.offline { background: var(--accent-red); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        /* Main Grid */
        .main-grid { display: grid; grid-template-columns: 1fr 1fr 380px; gap: 1.5rem; }
        @media (max-width: 1400px) { .main-grid { grid-template-columns: 1fr 1fr; } }
        @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }
        
        /* Cards */
        .card {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 14px; padding: 1.25rem; overflow: hidden;
        }
        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border);
        }
        .card-title {
            font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1.5px;
            color: var(--text-secondary); font-weight: 600;
        }
        .card-badge {
            font-size: 0.65rem; padding: 0.25rem 0.6rem; border-radius: 100px;
            background: var(--bg-elevated); color: var(--text-secondary);
        }
        
        /* DSO Prediction Card */
        .prediction-hero { text-align: center; padding: 1rem 0; }
        .prediction-icon { font-size: 4rem; margin-bottom: 0.5rem; }
        .prediction-type { font-size: 2rem; font-weight: 700; margin-bottom: 0.25rem; }
        .prediction-confidence { font-size: 0.85rem; color: var(--text-secondary); }
        .mechanism-box {
            background: var(--bg-elevated); padding: 1rem; border-radius: 10px;
            margin-top: 1rem; border-left: 3px solid var(--accent-blue);
        }
        .mechanism-box h4 { font-size: 0.75rem; color: var(--accent-blue); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 1px; }
        .mechanism-box p { font-size: 0.85rem; color: var(--text-secondary); line-height: 1.6; }
        
        /* NWS Current Conditions Card */
        .nws-current { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; }
        .nws-temp { font-size: 3rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        .nws-condition { font-size: 1.1rem; color: var(--text-secondary); }
        .nws-details { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
        .nws-detail { background: var(--bg-elevated); padding: 0.75rem; border-radius: 8px; }
        .nws-detail-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .nws-detail-value { font-family: 'JetBrains Mono', monospace; font-size: 1rem; margin-top: 0.25rem; }
        
        /* Comparison Box */
        .comparison-box {
            margin-top: 1rem; padding: 1rem; border-radius: 10px;
            border: 1px dashed var(--border);
        }
        .comparison-box.agree { border-color: var(--accent-green); background: rgba(34, 197, 94, 0.05); }
        .comparison-box.differ { border-color: var(--accent-orange); background: rgba(249, 115, 22, 0.05); }
        .comparison-header { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
        .comparison-icon { font-size: 1.2rem; }
        .comparison-title { font-size: 0.8rem; font-weight: 600; }
        .comparison-text { font-size: 0.8rem; color: var(--text-secondary); }
        
        /* Factor Gauges */
        .factors-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
        .factor-card { background: var(--bg-elevated); border-radius: 10px; padding: 1rem; }
        .factor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .factor-name { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .factor-value { font-family: 'JetBrains Mono', monospace; font-size: 1.3rem; font-weight: 600; }
        .factor-bar { height: 4px; background: var(--bg-dark); border-radius: 2px; overflow: hidden; }
        .factor-fill { height: 100%; border-radius: 2px; transition: width 0.5s ease; }
        .factor-desc { font-size: 0.7rem; color: var(--text-muted); margin-top: 0.5rem; }
        
        /* Alerts */
        .alerts-container { margin-bottom: 1rem; }
        .alert-item {
            padding: 0.75rem 1rem; border-radius: 8px; margin-bottom: 0.5rem;
            display: flex; align-items: flex-start; gap: 0.75rem;
        }
        .alert-warning { background: rgba(234, 179, 8, 0.15); border-left: 3px solid var(--accent-yellow); }
        .alert-watch { background: rgba(249, 115, 22, 0.15); border-left: 3px solid var(--accent-orange); }
        .alert-advisory { background: rgba(59, 130, 246, 0.15); border-left: 3px solid var(--accent-blue); }
        .alert-icon { font-size: 1.2rem; }
        .alert-content { flex: 1; }
        .alert-title { font-size: 0.85rem; font-weight: 600; }
        .alert-desc { font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem; }
        
        /* 7-Day Forecast */
        .forecast-scroll { display: flex; gap: 0.5rem; overflow-x: auto; padding-bottom: 0.5rem; }
        .forecast-day {
            flex: 0 0 auto; width: 90px; padding: 0.75rem;
            background: var(--bg-elevated); border-radius: 10px; text-align: center;
            cursor: pointer; transition: all 0.2s; border: 1px solid transparent;
        }
        .forecast-day:hover { border-color: var(--border); }
        .forecast-day.active { border-color: var(--accent-blue); background: rgba(59, 130, 246, 0.1); }
        .forecast-day-name { font-size: 0.75rem; font-weight: 600; margin-bottom: 0.5rem; }
        .forecast-day-icon { font-size: 1.5rem; margin-bottom: 0.5rem; }
        .forecast-day-temp { font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; }
        .forecast-day-hi { color: var(--accent-orange); }
        .forecast-day-lo { color: var(--accent-blue); }
        .forecast-day-dso { font-size: 0.65rem; color: var(--text-muted); margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border); }
        
        /* Catalyst Curve */
        .chart-container { height: 120px; position: relative; margin-top: 0.5rem; }
        .chart-svg { width: 100%; height: 100%; }
        
        /* Danger Index */
        .danger-display { text-align: center; padding: 1rem 0; }
        .danger-value { font-family: 'JetBrains Mono', monospace; font-size: 2.5rem; font-weight: 700; }
        .danger-label { font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem; }
        .danger-scale {
            display: flex; height: 8px; border-radius: 4px; overflow: hidden;
            margin-top: 1rem; gap: 2px;
        }
        .danger-segment { flex: 1; }
        .danger-marker {
            width: 3px; height: 16px; background: white; border-radius: 2px;
            position: relative; top: -4px; transition: margin-left 0.5s;
        }
        
        /* Sidebar */
        .sidebar { display: flex; flex-direction: column; gap: 1rem; }
        
        /* Equations Panel */
        .equations { font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; }
        .equation { padding: 0.5rem; background: var(--bg-elevated); border-radius: 6px; margin-bottom: 0.5rem; }
        .equation-name { color: var(--accent-cyan); }
        .equation-formula { color: var(--text-secondary); }
        
        /* Loading */
        .loading { text-align: center; padding: 2rem; color: var(--text-muted); }
        .spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--accent-blue); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Footer */
        footer {
            margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border);
            text-align: center; color: var(--text-muted); font-size: 0.8rem;
        }
        footer a { color: var(--accent-blue); text-decoration: none; }
        
        /* Responsive */
        @media (max-width: 600px) {
            .factors-grid { grid-template-columns: 1fr; }
            .nws-details { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">‚ö°</div>
                <div>
                    <h1>DSO Weather Intelligence</h1>
                    <span>E-Field Geometric Prediction ‚Ä¢ Arkansas</span>
                </div>
            </div>
            <div class="controls">
                <select id="regionSelect">
                    <option value="benton_ar">Benton, AR</option>
                    <option value="little_rock">Little Rock, AR</option>
                    <option value="haskell_ar">Haskell, AR</option>
                    <option value="fayetteville">Fayetteville, AR</option>
                    <option value="jonesboro">Jonesboro, AR</option>
                </select>
                <input type="date" id="dateSelect">
                <button class="btn" onclick="refresh()">‚Üª Refresh</button>
            </div>
        </header>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-dot" id="noaaStatus"></div>
                <span id="noaaStatusText">Connecting to NOAA...</span>
            </div>
            <div class="status-item">
                <span style="color: var(--text-muted)">Last update:</span>
                <span id="lastUpdate">--</span>
            </div>
            <div class="status-item" style="margin-left: auto;">
                <span style="color: var(--text-muted)">Model:</span>
                <span>DSO v2.0</span>
            </div>
        </div>

        <div id="alertsContainer" class="alerts-container"></div>

        <div class="main-grid">
            <!-- DSO Prediction -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">DSO Prediction</span>
                    <span class="card-badge" id="tempRegime">--</span>
                </div>
                <div class="prediction-hero">
                    <div class="prediction-icon" id="dsoIcon">--</div>
                    <div class="prediction-type" id="dsoPrediction">Loading...</div>
                    <div class="prediction-confidence">Confidence: <span id="dsoConfidence">--</span>%</div>
                </div>
                <div class="mechanism-box">
                    <h4>Why This Forecast</h4>
                    <p id="mechanismText">Loading mechanism explanation...</p>
                </div>
                
                <div style="margin-top: 1.25rem;">
                    <div class="card-title" style="margin-bottom: 0.75rem;">DSO Factors</div>
                    <div class="factors-grid">
                        <div class="factor-card">
                            <div class="factor-header">
                                <span class="factor-name">Catalyst (dŒ∏/dt)</span>
                                <span class="factor-value" id="catalystValue">--</span>
                            </div>
                            <div class="factor-bar"><div class="factor-fill" id="catalystBar" style="background: var(--accent-orange);"></div></div>
                            <div class="factor-desc">Rotation driver from Earth's tilt change rate</div>
                        </div>
                        <div class="factor-card">
                            <div class="factor-header">
                                <span class="factor-name">E-Gradient (‚àÇE/‚àÇœÜ)</span>
                                <span class="factor-value" id="gradientValue">--</span>
                            </div>
                            <div class="factor-bar"><div class="factor-fill" id="gradientBar" style="background: var(--accent-purple);"></div></div>
                            <div class="factor-desc">Air mass collision intensity</div>
                        </div>
                        <div class="factor-card">
                            <div class="factor-header">
                                <span class="factor-name">E-Fuel</span>
                                <span class="factor-value" id="fuelValue">--</span>
                            </div>
                            <div class="factor-bar"><div class="factor-fill" id="fuelBar" style="background: var(--accent-red);"></div></div>
                            <div class="factor-desc">Gulf moisture energy available</div>
                        </div>
                        <div class="factor-card">
                            <div class="factor-header">
                                <span class="factor-name">Solar Angle</span>
                                <span class="factor-value" id="solarValue">--</span>
                            </div>
                            <div class="factor-bar"><div class="factor-fill" id="solarBar" style="background: var(--accent-yellow);"></div></div>
                            <div class="factor-desc">Solar energy input intensity</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NWS Current Conditions -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">NWS Current Conditions</span>
                    <span class="card-badge" id="nwsStation">--</span>
                </div>
                <div class="nws-current">
                    <div class="nws-temp" id="nwsTemp">--¬∞</div>
                    <div>
                        <div class="nws-condition" id="nwsCondition">Loading...</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);" id="nwsFeelsLike">Feels like --¬∞</div>
                    </div>
                </div>
                <div class="nws-details">
                    <div class="nws-detail">
                        <div class="nws-detail-label">Humidity</div>
                        <div class="nws-detail-value" id="nwsHumidity">--%</div>
                    </div>
                    <div class="nws-detail">
                        <div class="nws-detail-label">Wind</div>
                        <div class="nws-detail-value" id="nwsWind">-- mph</div>
                    </div>
                    <div class="nws-detail">
                        <div class="nws-detail-label">Pressure</div>
                        <div class="nws-detail-value" id="nwsPressure">-- mb</div>
                    </div>
                    <div class="nws-detail">
                        <div class="nws-detail-label">Visibility</div>
                        <div class="nws-detail-value" id="nwsVisibility">-- mi</div>
                    </div>
                </div>
                
                <div class="comparison-box" id="comparisonBox">
                    <div class="comparison-header">
                        <span class="comparison-icon" id="comparisonIcon">‚öñÔ∏è</span>
                        <span class="comparison-title" id="comparisonTitle">DSO vs NWS Analysis</span>
                    </div>
                    <div class="comparison-text" id="comparisonText">Analyzing predictions...</div>
                </div>

                <div style="margin-top: 1.25rem;">
                    <div class="card-title" style="margin-bottom: 0.75rem;">NWS 7-Day Forecast</div>
                    <div class="forecast-scroll" id="forecastScroll">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Danger Index -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Danger Index</span>
                        <span class="card-badge" id="dangerLevel">--</span>
                    </div>
                    <div class="danger-display">
                        <div class="danger-value" id="dangerValue">--</div>
                        <div class="danger-label">D = E √ó ‚àáE √ó (dŒ∏/dt)¬≤ √ó sin¬≤(Œ±)</div>
                    </div>
                    <div class="danger-scale">
                        <div class="danger-segment" style="background: var(--accent-green);"></div>
                        <div class="danger-segment" style="background: var(--accent-yellow);"></div>
                        <div class="danger-segment" style="background: var(--accent-orange);"></div>
                        <div class="danger-segment" style="background: var(--accent-red);"></div>
                        <div class="danger-segment" style="background: #991b1b;"></div>
                    </div>
                    <div style="position: relative; height: 16px;">
                        <div class="danger-marker" id="dangerMarker"></div>
                    </div>
                </div>

                <!-- Discharge Mode -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Discharge Mode</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="font-family: 'JetBrains Mono'; font-size: 2rem; font-weight: 700;" id="inversionValue">--</div>
                        <div>
                            <div style="font-size: 0.9rem; font-weight: 600;" id="dischargeMode">--</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);" id="dischargeModeDesc">--</div>
                        </div>
                    </div>
                    <div style="margin-top: 1rem; font-size: 0.75rem; color: var(--text-muted);">
                        <div>R &gt; 1.2 ‚Üí Horizontal (cyclonic)</div>
                        <div>R &lt; 1.0 ‚Üí Vertical (convective)</div>
                    </div>
                </div>

                <!-- Catalyst Curve -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Annual Catalyst Curve</span>
                        <span class="card-badge" id="dayOfYear">Day --</span>
                    </div>
                    <div class="chart-container">
                        <svg class="chart-svg" id="catalystChart" viewBox="0 0 340 110"></svg>
                    </div>
                </div>

                <!-- Core Equations -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Core Equations</span>
                    </div>
                    <div class="equations">
                        <div class="equation">
                            <span class="equation-name">Probability:</span>
                            <span class="equation-formula">P = E √ó |dŒ∏/dt| √ó sin(Œ±)</span>
                        </div>
                        <div class="equation">
                            <span class="equation-name">Volatility:</span>
                            <span class="equation-formula">V = ‚àáE √ó |dŒ∏/dt| √ó sin(Œ±)</span>
                        </div>
                        <div class="equation">
                            <span class="equation-name">Danger:</span>
                            <span class="equation-formula">D = E √ó ‚àáE √ó (dŒ∏/dt)¬≤ √ó sin¬≤(Œ±)</span>
                        </div>
                        <div class="equation">
                            <span class="equation-name">Inversion:</span>
                            <span class="equation-formula">R = dŒ∏/dt √∑ (sin(Œ±) + 0.1)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>DSO Weather Intelligence v2.0 | <a href="https://doi.org/10.5281/zenodo.18193711" target="_blank">Research Publication</a> | Data: <a href="https://api.weather.gov" target="_blank">NWS API</a></p>
            <p style="margin-top: 0.5rem;">¬© 2026 Joe Garrett / VaultSync Solutions Inc. | "Weather is E-geometry, not chaos."</p>
        </footer>
    </div>

    <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //                           DSO WEATHER ENGINE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    const regions = {
        'benton_ar':    { name: 'Benton, AR',      lat: 34.5645, lon: -92.5868, gulfDist: 650, gradientZone: 0.85 },
        'little_rock':  { name: 'Little Rock, AR', lat: 34.7465, lon: -92.2896, gulfDist: 680, gradientZone: 0.82 },
        'haskell_ar':   { name: 'Haskell, AR',     lat: 34.5012, lon: -92.6368, gulfDist: 645, gradientZone: 0.86 },
        'fayetteville': { name: 'Fayetteville, AR',lat: 36.0626, lon: -94.1574, gulfDist: 780, gradientZone: 0.78 },
        'jonesboro':    { name: 'Jonesboro, AR',   lat: 35.8423, lon: -90.7043, gulfDist: 620, gradientZone: 0.80 }
    };

    const weatherMeta = {
        TORNADO:        { icon: 'üå™Ô∏è', color: '#dc2626', severity: 10 },
        SUPERCELL:      { icon: 'üå©Ô∏è', color: '#ea580c', severity: 9 },
        SEVERE_TSTORM:  { icon: '‚õàÔ∏è', color: '#f59e0b', severity: 8 },
        DERECHO:        { icon: 'üí®', color: '#0891b2', severity: 8 },
        BOMB_CYCLONE:   { icon: 'üåÄ', color: '#7c3aed', severity: 8 },
        BLIZZARD:       { icon: 'üå®Ô∏è', color: '#6366f1', severity: 7 },
        ICE_STORM:      { icon: 'üßä', color: '#8b5cf6', severity: 7 },
        WINTER_STORM:   { icon: '‚ùÑÔ∏è', color: '#3b82f6', severity: 6 },
        HIGH_WIND:      { icon: 'üå¨Ô∏è', color: '#06b6d4', severity: 5 },
        THUNDERSTORM:   { icon: '‚õàÔ∏è', color: '#eab308', severity: 5 },
        FREEZING_RAIN:  { icon: 'üåßÔ∏è', color: '#a855f7', severity: 5 },
        SNOW:           { icon: 'üå®Ô∏è', color: '#60a5fa', severity: 4 },
        WINTER_MIX:     { icon: 'üå®Ô∏è', color: '#818cf8', severity: 4 },
        SHOWERS:        { icon: 'üå¶Ô∏è', color: '#22c55e', severity: 3 },
        RAIN:           { icon: 'üåßÔ∏è', color: '#10b981', severity: 3 },
        DRIZZLE:        { icon: 'üåßÔ∏è', color: '#6ee7b7', severity: 2 },
        FOG:            { icon: 'üå´Ô∏è', color: '#9ca3af', severity: 2 },
        CLOUDY:         { icon: '‚òÅÔ∏è', color: '#d1d5db', severity: 1 },
        PARTLY_CLOUDY:  { icon: '‚õÖ', color: '#e5e7eb', severity: 1 },
        FAIR:           { icon: '‚òÄÔ∏è', color: '#fbbf24', severity: 0 }
    };

    class DSOEngine {
        getDayOfYear(date) {
            const start = new Date(date.getFullYear(), 0, 0);
            return Math.floor((date - start) / (1000 * 60 * 60 * 24));
        }
        
        getCatalyst(doy) {
            const phase = (2 * Math.PI * (doy - 80)) / 365.25;
            return Math.abs(23.5 * (2 * Math.PI / 365.25) * Math.cos(phase)) / 0.405;
        }
        
        getSolarAngle(doy, lat) {
            const dec = 23.45 * Math.sin((2 * Math.PI / 365.25) * (doy - 81));
            const decRad = dec * Math.PI / 180;
            const latRad = lat * Math.PI / 180;
            return Math.max(0, Math.min(1, Math.sin(latRad) * Math.sin(decRad) + Math.cos(latRad) * Math.cos(decRad)));
        }
        
        getGulfSST(doy) {
            return 26.5 + 3 * Math.sin((2 * Math.PI * (doy - 45)) / 365.25);
        }
        
        getFuel(doy, gulfDist) {
            const sst = this.getGulfSST(doy);
            return Math.max(0, Math.min(1, ((sst - 20) / 12) * Math.exp(-gulfDist / 1500) * 1.5));
        }
        
        getGradient(doy, zone = 0.85) {
            const spring = Math.exp(-Math.pow((doy - 100) / 45, 2));
            const fall = Math.exp(-Math.pow((doy - 290) / 50, 2)) * 0.7;
            return Math.max(spring, fall) * zone;
        }
        
        calculate(date, region) {
            const doy = this.getDayOfYear(date);
            const catalyst = this.getCatalyst(doy);
            const solarAngle = this.getSolarAngle(doy, region.lat);
            const fuel = this.getFuel(doy, region.gulfDist);
            const gradient = this.getGradient(doy, region.gradientZone);
            const inversionRatio = catalyst / (solarAngle + 0.1);
            const danger = fuel * gradient * Math.pow(catalyst, 2) * Math.pow(solarAngle, 2);
            const probability = fuel * catalyst * solarAngle;
            const volatility = gradient * catalyst * solarAngle;
            
            return { doy, catalyst, solarAngle, fuel, gradient, inversionRatio, danger, probability, volatility };
        }
        
        classify(factors) {
            const { catalyst, gradient, fuel, solarAngle, inversionRatio, danger } = factors;
            
            const tempScore = (solarAngle * 0.6) + (fuel * 0.4);
            const tempRegime = tempScore < 0.35 ? 'COLD' : tempScore < 0.50 ? 'COOL' : 
                              tempScore < 0.65 ? 'MILD' : tempScore < 0.80 ? 'WARM' : 'HOT';
            
            let type = 'FAIR';
            let confidence = 0.5;
            let mechanism = '';
            
            if (catalyst > 0.50 && gradient > 0.45 && fuel > 0.40 && danger > 0.05 && inversionRatio < 1.0) {
                type = 'TORNADO';
                confidence = Math.min(0.95, 0.5 + catalyst * 0.3 + gradient * 0.2);
                mechanism = `High catalyst (${(catalyst*100).toFixed(0)}%) + high gradient (${(gradient*100).toFixed(0)}%) = maximum rotational potential. Gulf moisture fueling supercell development.`;
            }
            else if (catalyst > 0.40 && gradient > 0.35 && fuel > 0.35) {
                type = 'SUPERCELL';
                confidence = 0.7 + gradient * 0.2;
                mechanism = `Strong rotation driver with organized gradient. Conditions favor rotating storms.`;
            }
            else if (catalyst > 0.25 && gradient > 0.10 && fuel > 0.30) {
                type = 'SEVERE_TSTORM';
                confidence = 0.6 + catalyst * 0.2;
                mechanism = `Moderate catalyst with sufficient gradient for storm organization. Watch for damaging winds and hail.`;
            }
            else if (catalyst < 0.35 && fuel > 0.65 && solarAngle > 0.70) {
                type = 'DERECHO';
                confidence = 0.65;
                mechanism = `Low catalyst (${(catalyst*100).toFixed(0)}%) prevents rotation, but high fuel (${(fuel*100).toFixed(0)}%) drives linear wind damage.`;
            }
            else if (inversionRatio > 1.2 && fuel > 0.40) {
                type = 'BOMB_CYCLONE';
                confidence = 0.7;
                mechanism = `Inversion ratio ${inversionRatio.toFixed(2)} > 1.2: horizontal discharge mode. Rapid cyclogenesis likely.`;
            }
            else if (catalyst > 0.40 && solarAngle < 0.55 && fuel < 0.40) {
                type = 'WINTER_STORM';
                confidence = 0.65;
                mechanism = `Cold regime with active catalyst. Organized winter precipitation.`;
            }
            else if (solarAngle < 0.60 && fuel > 0.20 && fuel < 0.45) {
                if (solarAngle > 0.45) {
                    type = 'FREEZING_RAIN';
                    mechanism = `Borderline temperatures with moisture. Freezing rain risk.`;
                } else {
                    type = 'SNOW';
                    mechanism = `Cold solar angle (${(solarAngle*100).toFixed(0)}%) with available moisture.`;
                }
                confidence = 0.6;
            }
            else if (fuel > 0.35 && solarAngle > 0.50 && catalyst > 0.15) {
                type = 'THUNDERSTORM';
                confidence = 0.6;
                mechanism = `Adequate fuel and solar heating. Diurnal thunderstorm development.`;
            }
            else if (fuel > 0.25 && solarAngle > 0.40) {
                type = 'SHOWERS';
                confidence = 0.55;
                mechanism = `Moderate moisture with heating. Scattered shower activity.`;
            }
            else if (fuel > 0.20) {
                type = 'RAIN';
                confidence = 0.5;
                mechanism = `Sufficient moisture for precipitation.`;
            }
            else if (fuel > 0.15 && catalyst < 0.25) {
                type = 'CLOUDY';
                confidence = 0.6;
                mechanism = `Low energy state. Cloud cover without significant precipitation.`;
            }
            else if (fuel < 0.25 && catalyst < 0.30) {
                type = 'FAIR';
                confidence = 0.7;
                mechanism = `Low fuel, low catalyst = stable atmosphere. Fair weather.`;
            }
            else {
                type = 'PARTLY_CLOUDY';
                confidence = 0.5;
                mechanism = `Mixed signals in factors. Variable conditions.`;
            }
            
            let dangerLevel = 'MINIMAL';
            if (danger > 0.15) dangerLevel = 'EXTREME';
            else if (danger > 0.08) dangerLevel = 'HIGH';
            else if (danger > 0.04) dangerLevel = 'MODERATE';
            else if (danger > 0.02) dangerLevel = 'LOW';
            
            const meta = weatherMeta[type] || weatherMeta.FAIR;
            
            return {
                type, confidence, mechanism, tempRegime, dangerLevel,
                icon: meta.icon, color: meta.color, severity: meta.severity
            };
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //                           NOAA API INTEGRATION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    class NOAAClient {
        constructor() {
            this.baseUrl = 'https://api.weather.gov';
            this.cache = {};
        }
        
        async getPointData(lat, lon) {
            const key = `${lat},${lon}`;
            if (this.cache[key]?.pointData) return this.cache[key].pointData;
            
            try {
                const resp = await fetch(`${this.baseUrl}/points/${lat},${lon}`, {
                    headers: { 'User-Agent': 'DSO Weather Intelligence (github.com/garrjo/dso_weather)' }
                });
                if (!resp.ok) throw new Error(`Points API error: ${resp.status}`);
                const data = await resp.json();
                this.cache[key] = this.cache[key] || {};
                this.cache[key].pointData = data;
                return data;
            } catch (e) {
                console.error('NOAA Points error:', e);
                return null;
            }
        }
        
        async getForecast(lat, lon) {
            try {
                const pointData = await this.getPointData(lat, lon);
                if (!pointData) return null;
                
                const forecastUrl = pointData.properties.forecast;
                const resp = await fetch(forecastUrl, {
                    headers: { 'User-Agent': 'DSO Weather Intelligence' }
                });
                if (!resp.ok) throw new Error(`Forecast API error: ${resp.status}`);
                return await resp.json();
            } catch (e) {
                console.error('NOAA Forecast error:', e);
                return null;
            }
        }
        
        async getObservations(lat, lon) {
            try {
                const pointData = await this.getPointData(lat, lon);
                if (!pointData) return null;
                
                const stationsUrl = pointData.properties.observationStations;
                const stationsResp = await fetch(stationsUrl, {
                    headers: { 'User-Agent': 'DSO Weather Intelligence' }
                });
                if (!stationsResp.ok) return null;
                const stations = await stationsResp.json();
                
                if (!stations.features?.length) return null;
                const stationId = stations.features[0].properties.stationIdentifier;
                
                const obsResp = await fetch(`${this.baseUrl}/stations/${stationId}/observations/latest`, {
                    headers: { 'User-Agent': 'DSO Weather Intelligence' }
                });
                if (!obsResp.ok) return null;
                const obs = await obsResp.json();
                obs.stationId = stationId;
                return obs;
            } catch (e) {
                console.error('NOAA Observations error:', e);
                return null;
            }
        }
        
        async getAlerts(lat, lon) {
            try {
                const resp = await fetch(`${this.baseUrl}/alerts/active?point=${lat},${lon}`, {
                    headers: { 'User-Agent': 'DSO Weather Intelligence' }
                });
                if (!resp.ok) return [];
                const data = await resp.json();
                return data.features || [];
            } catch (e) {
                console.error('NOAA Alerts error:', e);
                return [];
            }
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //                           UI CONTROLLER
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    const engine = new DSOEngine();
    const noaa = new NOAAClient();
    let currentRegion = 'benton_ar';
    let currentDate = new Date();
    
    document.getElementById('dateSelect').valueAsDate = currentDate;
    
    async function refresh() {
        const region = regions[currentRegion];
        const date = new Date(document.getElementById('dateSelect').value + 'T12:00:00');
        
        const factors = engine.calculate(date, region);
        const classification = engine.classify(factors);
        
        updateDSODisplay(factors, classification);
        updateCatalystChart(factors.doy);
        
        updateNOAAStatus('loading');
        
        const [observations, forecast, alerts] = await Promise.all([
            noaa.getObservations(region.lat, region.lon),
            noaa.getForecast(region.lat, region.lon),
            noaa.getAlerts(region.lat, region.lon)
        ]);
        
        if (observations || forecast) {
            updateNOAAStatus('live');
            updateNOAADisplay(observations, forecast);
            updateAlerts(alerts);
            updateComparison(classification, observations, forecast);
        } else {
            updateNOAAStatus('offline');
        }
        
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
    }
    
    function updateDSODisplay(factors, classification) {
        document.getElementById('dsoIcon').textContent = classification.icon;
        document.getElementById('dsoPrediction').textContent = classification.type.replace('_', ' ');
        document.getElementById('dsoPrediction').style.color = classification.color;
        document.getElementById('dsoConfidence').textContent = (classification.confidence * 100).toFixed(0);
        document.getElementById('tempRegime').textContent = classification.tempRegime;
        document.getElementById('mechanismText').textContent = classification.mechanism;
        
        document.getElementById('catalystValue').textContent = (factors.catalyst * 100).toFixed(1) + '%';
        document.getElementById('catalystBar').style.width = (factors.catalyst * 100) + '%';
        
        document.getElementById('gradientValue').textContent = (factors.gradient * 100).toFixed(1) + '%';
        document.getElementById('gradientBar').style.width = (factors.gradient * 100) + '%';
        
        document.getElementById('fuelValue').textContent = (factors.fuel * 100).toFixed(1) + '%';
        document.getElementById('fuelBar').style.width = (factors.fuel * 100) + '%';
        
        document.getElementById('solarValue').textContent = (factors.solarAngle * 100).toFixed(1) + '%';
        document.getElementById('solarBar').style.width = (factors.solarAngle * 100) + '%';
        
        document.getElementById('dangerValue').textContent = factors.danger.toFixed(5);
        document.getElementById('dangerLevel').textContent = classification.dangerLevel;
        const dangerPct = Math.min(100, factors.danger * 500);
        document.getElementById('dangerMarker').style.marginLeft = dangerPct + '%';
        
        document.getElementById('inversionValue').textContent = factors.inversionRatio.toFixed(2);
        const mode = factors.inversionRatio > 1.2 ? 'HORIZONTAL' : factors.inversionRatio > 1.0 ? 'TRANSITIONAL' : 'VERTICAL';
        document.getElementById('dischargeMode').textContent = mode;
        document.getElementById('dischargeModeDesc').textContent = 
            mode === 'HORIZONTAL' ? 'Cyclonic (bomb cyclone)' :
            mode === 'TRANSITIONAL' ? 'Mixed mode' : 'Convective (storms)';
        
        document.getElementById('dayOfYear').textContent = 'Day ' + factors.doy;
    }
    
    function updateNOAADisplay(obs, forecast) {
        if (obs?.properties) {
            const p = obs.properties;
            const tempC = p.temperature?.value;
            const tempF = tempC !== null ? Math.round(tempC * 9/5 + 32) : '--';
            
            document.getElementById('nwsTemp').textContent = tempF + '¬∞';
            document.getElementById('nwsCondition').textContent = p.textDescription || 'N/A';
            
            const windC = p.windChill?.value;
            const heatI = p.heatIndex?.value;
            const feelsLike = windC ?? heatI ?? tempC;
            const feelsF = feelsLike !== null ? Math.round(feelsLike * 9/5 + 32) : '--';
            document.getElementById('nwsFeelsLike').textContent = `Feels like ${feelsF}¬∞`;
            
            const humidity = p.relativeHumidity?.value;
            document.getElementById('nwsHumidity').textContent = humidity !== null ? Math.round(humidity) + '%' : '--%';
            
            const windMs = p.windSpeed?.value;
            const windMph = windMs !== null ? Math.round(windMs * 2.237) : '--';
            const windDir = p.windDirection?.value;
            const windDirStr = windDir !== null ? getWindDirection(windDir) : '';
            document.getElementById('nwsWind').textContent = `${windDirStr} ${windMph} mph`;
            
            const pressurePa = p.barometricPressure?.value;
            const pressureMb = pressurePa !== null ? Math.round(pressurePa / 100) : '--';
            document.getElementById('nwsPressure').textContent = pressureMb + ' mb';
            
            const visM = p.visibility?.value;
            const visMi = visM !== null ? Math.round(visM / 1609) : '--';
            document.getElementById('nwsVisibility').textContent = visMi + ' mi';
            
            document.getElementById('nwsStation').textContent = obs.stationId || 'N/A';
        }
        
        if (forecast?.properties?.periods) {
            updateForecastScroll(forecast.properties.periods);
        }
    }
    
    function updateForecastScroll(periods) {
        const container = document.getElementById('forecastScroll');
        container.innerHTML = '';
        
        const region = regions[currentRegion];
        const days = [];
        let currentDay = null;
        
        for (const p of periods) {
            const date = new Date(p.startTime);
            const dayKey = date.toDateString();
            
            if (currentDay !== dayKey) {
                if (days.length >= 7) break;
                days.push({ date, periods: [p] });
                currentDay = dayKey;
            } else {
                days[days.length - 1].periods.push(p);
            }
        }
        
        days.forEach((day, i) => {
            const dayPeriod = day.periods.find(p => p.isDaytime) || day.periods[0];
            const nightPeriod = day.periods.find(p => !p.isDaytime);
            
            const dsoFactors = engine.calculate(day.date, region);
            const dsoClass = engine.classify(dsoFactors);
            
            const div = document.createElement('div');
            div.className = 'forecast-day' + (i === 0 ? ' active' : '');
            div.onclick = () => selectForecastDay(day.date, div);
            
            div.innerHTML = `
                <div class="forecast-day-name">${i === 0 ? 'Today' : day.date.toLocaleDateString('en-US', { weekday: 'short' })}</div>
                <div class="forecast-day-icon">${getNWSIcon(dayPeriod.shortForecast)}</div>
                <div class="forecast-day-temp">
                    <span class="forecast-day-hi">${dayPeriod.temperature}¬∞</span>
                    ${nightPeriod ? `<span class="forecast-day-lo">${nightPeriod.temperature}¬∞</span>` : ''}
                </div>
                <div class="forecast-day-dso">${dsoClass.icon} ${dsoClass.type.substring(0, 8)}</div>
            `;
            container.appendChild(div);
        });
    }
    
    function selectForecastDay(date, element) {
        document.querySelectorAll('.forecast-day').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
        document.getElementById('dateSelect').valueAsDate = date;
        
        const region = regions[currentRegion];
        const factors = engine.calculate(date, region);
        const classification = engine.classify(factors);
        updateDSODisplay(factors, classification);
        updateCatalystChart(factors.doy);
    }
    
    function updateAlerts(alerts) {
        const container = document.getElementById('alertsContainer');
        container.innerHTML = '';
        
        if (!alerts.length) return;
        
        alerts.slice(0, 3).forEach(alert => {
            const props = alert.properties;
            const alertClass = props.event?.toLowerCase().includes('warning') ? 'alert-warning' :
                              props.event?.toLowerCase().includes('watch') ? 'alert-watch' : 'alert-advisory';
            
            const div = document.createElement('div');
            div.className = `alert-item ${alertClass}`;
            div.innerHTML = `
                <div class="alert-icon">‚ö†Ô∏è</div>
                <div class="alert-content">
                    <div class="alert-title">${props.event}</div>
                    <div class="alert-desc">${props.headline?.substring(0, 150) || ''}...</div>
                </div>
            `;
            container.appendChild(div);
        });
    }
    
    function updateComparison(dsoClass, obs, forecast) {
        const box = document.getElementById('comparisonBox');
        const icon = document.getElementById('comparisonIcon');
        const title = document.getElementById('comparisonTitle');
        const text = document.getElementById('comparisonText');
        
        if (!forecast?.properties?.periods?.length) {
            text.textContent = 'Unable to compare - NWS data unavailable';
            return;
        }
        
        const nwsForecast = forecast.properties.periods[0].shortForecast.toLowerCase();
        const dsoType = dsoClass.type.toLowerCase();
        
        const nwsSevere = nwsForecast.includes('tornado') || nwsForecast.includes('severe') || 
                         nwsForecast.includes('thunder') || nwsForecast.includes('storm');
        const dsoSevere = dsoClass.severity >= 5;
        
        const nwsWinter = nwsForecast.includes('snow') || nwsForecast.includes('ice') || 
                         nwsForecast.includes('freezing') || nwsForecast.includes('winter');
        const dsoWinter = dsoType.includes('snow') || dsoType.includes('ice') || 
                         dsoType.includes('winter') || dsoType.includes('freezing');
        
        const nwsRain = nwsForecast.includes('rain') || nwsForecast.includes('shower');
        const dsoRain = dsoType.includes('rain') || dsoType.includes('shower') || dsoType.includes('drizzle');
        
        const nwsClear = nwsForecast.includes('sunny') || nwsForecast.includes('clear') || nwsForecast.includes('fair');
        const dsoClear = dsoType === 'fair' || dsoType === 'partly_cloudy';
        
        const agree = (nwsSevere && dsoSevere) || (nwsWinter && dsoWinter) || 
                     (nwsRain && dsoRain) || (nwsClear && dsoClear) ||
                     (!nwsSevere && !dsoSevere && !nwsWinter && !dsoWinter);
        
        if (agree) {
            box.className = 'comparison-box agree';
            icon.textContent = '‚úì';
            title.textContent = 'DSO & NWS Agree';
            text.textContent = `Both models predict similar conditions. DSO adds: ${dsoClass.mechanism.substring(0, 100)}...`;
        } else {
            box.className = 'comparison-box differ';
            icon.textContent = '‚ö°';
            title.textContent = 'DSO Differs from NWS';
            
            if (dsoSevere && !nwsSevere) {
                text.textContent = `DSO sees elevated severe risk (catalyst ${(engine.calculate(new Date(), regions[currentRegion]).catalyst * 100).toFixed(0)}%) that NWS may not capture. Monitor closely.`;
            } else if (!dsoSevere && nwsSevere) {
                text.textContent = `NWS shows severe weather but DSO factors are low. Possible localized event outside DSO's geometric scope.`;
            } else {
                text.textContent = `Different interpretations. NWS: "${forecast.properties.periods[0].shortForecast}". DSO factors suggest: ${dsoClass.type}.`;
            }
        }
    }
    
    function updateCatalystChart(currentDoy) {
        const svg = document.getElementById('catalystChart');
        const width = 340, height = 110;
        const pad = { top: 5, right: 10, bottom: 20, left: 25 };
        const cw = width - pad.left - pad.right;
        const ch = height - pad.top - pad.bottom;
        
        let path = '';
        for (let d = 1; d <= 365; d++) {
            const c = engine.getCatalyst(d);
            const x = pad.left + (d / 365) * cw;
            const y = pad.top + ch - (c * ch);
            path += (d === 1 ? 'M' : 'L') + x.toFixed(1) + ',' + y.toFixed(1);
        }
        
        const cx = pad.left + (currentDoy / 365) * cw;
        const cy = pad.top + ch - (engine.getCatalyst(currentDoy) * ch);
        
        svg.innerHTML = `
            <line x1="${pad.left}" y1="${pad.top}" x2="${pad.left}" y2="${height - pad.bottom}" stroke="#2a2a3a"/>
            <line x1="${pad.left}" y1="${height - pad.bottom}" x2="${width - pad.right}" y2="${height - pad.bottom}" stroke="#2a2a3a"/>
            <text x="${pad.left + cw * 0.22}" y="${height - 5}" fill="#555" font-size="9">Mar</text>
            <text x="${pad.left + cw * 0.47}" y="${height - 5}" fill="#555" font-size="9">Jun</text>
            <text x="${pad.left + cw * 0.72}" y="${height - 5}" fill="#555" font-size="9">Sep</text>
            <text x="${pad.left + cw * 0.95}" y="${height - 5}" fill="#555" font-size="9">Dec</text>
            <path d="${path}" fill="none" stroke="#f97316" stroke-width="2"/>
            <circle cx="${cx}" cy="${cy}" r="5" fill="#ef4444"/>
            <circle cx="${cx}" cy="${cy}" r="9" fill="none" stroke="#ef4444" stroke-width="2" opacity="0.4"/>
        `;
    }
    
    function updateNOAAStatus(status) {
        const dot = document.getElementById('noaaStatus');
        const text = document.getElementById('noaaStatusText');
        
        if (status === 'live') {
            dot.className = 'status-dot live';
            text.textContent = 'NOAA Live';
        } else if (status === 'loading') {
            dot.className = 'status-dot';
            dot.style.background = 'var(--accent-yellow)';
            text.textContent = 'Fetching NOAA data...';
        } else {
            dot.className = 'status-dot offline';
            text.textContent = 'NOAA Offline';
        }
    }
    
    function getWindDirection(degrees) {
        const dirs = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
        return dirs[Math.round(degrees / 22.5) % 16];
    }
    
    function getNWSIcon(forecast) {
        const f = forecast.toLowerCase();
        if (f.includes('tornado')) return 'üå™Ô∏è';
        if (f.includes('thunder') || f.includes('tstorm')) return '‚õàÔ∏è';
        if (f.includes('snow')) return 'üå®Ô∏è';
        if (f.includes('ice') || f.includes('freezing')) return 'üßä';
        if (f.includes('rain') || f.includes('shower')) return 'üåßÔ∏è';
        if (f.includes('cloudy')) return f.includes('partly') ? '‚õÖ' : '‚òÅÔ∏è';
        if (f.includes('fog')) return 'üå´Ô∏è';
        if (f.includes('wind')) return 'üå¨Ô∏è';
        if (f.includes('sunny') || f.includes('clear')) return '‚òÄÔ∏è';
        return 'üå§Ô∏è';
    }
    
    document.getElementById('regionSelect').addEventListener('change', (e) => {
        currentRegion = e.target.value;
        noaa.cache = {};
        refresh();
    });
    
    document.getElementById('dateSelect').addEventListener('change', () => refresh());
    
    refresh();
    setInterval(refresh, 600000);
    </script>
</body>
</html>
